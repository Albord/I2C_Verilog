/*
	Autor: Albert Espiña Rojas
	Modulo: I2C_SLAVE_MEMORY
	Modulo de memoria. Podemos acceder y guardar datos. 
	El modulo tiene como parametro, el tamaño de la dirección de memoria, el número de direcciónes ,es decir el número de datos
	y el número de bytes en los datos

*/

module I2C_SLAVE_MEMORY #( parameter ADDRESSLENGTH, parameter ADDRESSNUM, parameter NBYTES)(Enable, Mode, RorW, DirectionBuffer, InputBuffer, OutputBuffer, AddressFound, AddressList, Data);
	input Enable; //
	input Mode;
	input RorW;
	input [((ADDRESSLENGTH)*ADDRESSNUM) - 1: 0]AddressList;
	output reg AddressFound = 1'b0;


	input wire [(ADDRESSLENGTH-1): 0] DirectionBuffer;
	input wire [7:0]InputBuffer;
	output reg [7:0]OutputBuffer;

	output reg [8*NBYTES*ADDRESSNUM: 0 ] Data = 1'b0;
	integer LocalAddressID = 0;
	integer ByteCounter = 0;
	

always @(posedge Enable)//Si se activa el enable, es cuando transferimos los datos del buffer a la memoria
begin
	if (Mode) begin //Modo transferencia, intercambiamos datos entre el buffer y los datos de la memoria
		if (RorW) OutputBuffer <= Data[(ByteCounter+1)*(8) +:1];
		else Data[LocalAddressID*8*NBYTES + (ByteCounter)*(8) +:1] <= InputBuffer;
		if (ByteCounter < NBYTES - 1) ByteCounter <= ByteCounter + 1;
	end
	else begin //El enable también puede ser para ver si se dispone de una dirección de memoria
		AddressFound <= 1'b0;
		ByteCounter <= 0;
		for(LocalAddressID = 0; (LocalAddressID < ADDRESSNUM) ||  !AddressFound; LocalAddressID = LocalAddressID + 1) begin
			if (AddressList[ADDRESSLENGTH*(LocalAddressID+1)+:1] == DirectionBuffer) AddressFound <= 1'b1;
		end
	end
end

endmodule